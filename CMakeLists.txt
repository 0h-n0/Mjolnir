cmake_minimum_required(VERSION 2.8)
enable_testing()
project(mjolnir)

include_directories(${PROJECT_SOURCE_DIR})
include_directories(${PROJECT_SOURCE_DIR}/extlib)

option(DEBUG "dump debug information" OFF)
if(DEBUG)
    add_definitions(-DMJOLNIR_DEBUG)
else(DEBUG)
    add_definitions(-DMJOLNIR_NO_DEBUG)
endif(DEBUG)

add_definitions("-std=c++11 -Ofast -march=native -mtune=native")

if(${CMAKE_SYSTEM_NAME} STREQUAL "Linux")
    execute_process(COMMAND cat /proc/cpuinfo OUTPUT_FILE "cpuinfo.dat")
    execute_process(COMMAND grep flags "cpuinfo.dat" OUTPUT_FILE "flags.dat")
    execute_process(COMMAND head --lines=1 "flags.dat" OUTPUT_FILE "cpuinfo.dat")
    execute_process(COMMAND rm "flags.dat")
    exec_program(grep ARGS "--count mmx    cpuinfo.dat" OUTPUT_VARIABLE cpu_found_mmx)
    exec_program(grep ARGS "--count sse    cpuinfo.dat" OUTPUT_VARIABLE cpu_found_sse)
    exec_program(grep ARGS "--count sse2   cpuinfo.dat" OUTPUT_VARIABLE cpu_found_sse2)
    exec_program(grep ARGS "--count sse3   cpuinfo.dat" OUTPUT_VARIABLE cpu_found_sse3)
    exec_program(grep ARGS "--count sse4_1 cpuinfo.dat" OUTPUT_VARIABLE cpu_found_sse4_1)
    exec_program(grep ARGS "--count sse4_2 cpuinfo.dat" OUTPUT_VARIABLE cpu_found_sse4_2)
    exec_program(grep ARGS "--count fma    cpuinfo.dat" OUTPUT_VARIABLE cpu_found_fma)
    exec_program(grep ARGS "--count avx    cpuinfo.dat" OUTPUT_VARIABLE cpu_found_avx)
    exec_program(grep ARGS "--count avx2   cpuinfo.dat" OUTPUT_VARIABLE cpu_found_avx2)
elseif(${CMAKE_SYSTEM_NAME} STREQUAL "Darwin")
    execute_process(COMMAND "/usr/sbin/sysctl -n machdep.cpu.features" OUTPUT_FILE "cpuinfo.dat")
    exec_program(grep ARGS "--count MMX    cpuinfo.dat" OUTPUT_VARIABLE cpu_found_mmx)
    exec_program(grep ARGS "--count SSE    cpuinfo.dat" OUTPUT_VARIABLE cpu_found_sse)
    exec_program(grep ARGS "--count SSE2   cpuinfo.dat" OUTPUT_VARIABLE cpu_found_sse2)
    exec_program(grep ARGS "--count SSE3   cpuinfo.dat" OUTPUT_VARIABLE cpu_found_sse3)
    exec_program(grep ARGS "--count SSE4.1 cpuinfo.dat" OUTPUT_VARIABLE cpu_found_sse4_1)
    exec_program(grep ARGS "--count SSE4.2 cpuinfo.dat" OUTPUT_VARIABLE cpu_found_sse4_2)
    exec_program(grep ARGS "--count FMA    cpuinfo.dat" OUTPUT_VARIABLE cpu_found_fma)
    exec_program(grep ARGS "--count AVX    cpuinfo.dat" OUTPUT_VARIABLE cpu_found_avx)
    exec_program(grep ARGS "--count AVX2   cpuinfo.dat" OUTPUT_VARIABLE cpu_found_avx2)
endif()

if(cpu_found_mmx GREATER 0)
    message(STATUS "MMX found")
    add_definitions(-DMJOLNIR_HAVE_MMX)
endif()

if(cpu_found_sse GREATER 0)
    message(STATUS "SSE found")
    add_definitions(-DMJOLNIR_HAVE_SSE)
endif()

if(cpu_found_sse2 GREATER 0)
    message(STATUS "SSE2 found")
    add_definitions(-DMJOLNIR_HAVE_SSE2)
endif()

if(cpu_found_sse3 GREATER 0)
    message(STATUS "SSE3 found")
    add_definitions(-DMJOLNIR_HAVE_SSE3)
endif()

if(cpu_found_sse4_1 GREATER 0)
    message(STATUS "SSE4.1 found")
    add_definitions(-DMJOLNIR_HAVE_SSE4_1)
endif()

if(cpu_found_sse4_2 GREATER 0)
    message(STATUS "SSE4.2 found")
    add_definitions(-DMJOLNIR_HAVE_SSE4_2)
endif()

if(cpu_found_avx GREATER 0)
    message(STATUS "AVX found")
    add_definitions(-DMJOLNIR_HAVE_AVX)
endif()

if(cpu_found_avx2 GREATER 0)
    message(STATUS "AVX2 found")
    add_definitions(-DMJOLNIR_HAVE_AVX2)
endif()

if(cpu_found_fma GREATER 0)
    message(STATUS "FMA found")
    add_definitions(-DMJOLNIR_HAVE_FMA)
endif()

add_subdirectory(src)
add_subdirectory(test)
